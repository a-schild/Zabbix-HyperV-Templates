zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 0b4d87047ee14edb98a87b309ee5a803
      name: 'HyperV VM'
    - uuid: 7df96b18c230490a9a0a9e2307226338
      name: Templates
    - uuid: aea23489ce3a49b6806ebb28e0cda430
      name: Windows
  templates:
    - uuid: 553c9735a18645849c38ebda859ace9c
      template: 'Template Windows HyperV VM Guest 2025'
      name: 'Template Windows HyperV VM Guest 2025'
      description: 'Child template, to create new Hyper-V VM monitoring from the Template Windows HyperV Host 2025 template'
      groups:
        - name: 'HyperV VM'
        - name: Templates
        - name: Windows
      items:
        - uuid: 4f64fea3b76c4d6fa818eab8e96a97e4
          name: 'HyperV CPU usage [{HOST.NAME}]'
          key: 'hyperv.cpu.usage2[{HOST.NAME},*]'
          value_type: FLOAT
          units: '%'
        - uuid: 823f8e1df92a4276af7188394af21a38
          name: 'Hyper-V VM Counters Master Data'
          key: 'hyperv.vm.counters[{HOST.HOST}]'
          delay: 5m
          value_type: TEXT
          trends: '0'
          description: |
            Master item containing all counter discovery data for dependent items
            
            Needs to be passive agent, as the request must be processed by the Hyper-V server itself and not the VM
          timeout: 30s
      discovery_rules:
        - uuid: 9693f27950fe4ecf9aec95e6bd4f10d0
          name: 'Hyper-V VM CPU Discovery'
          type: DEPENDENT
          key: hyperv.vm.cpu.discovery
          delay: '0'
          description: 'Discovers CPU performance counters for this Hyper-V VM'
          item_prototypes:
            - uuid: a104f4165a5246eebfc4f5676149a661
              name: 'Hyper-V CPU Usage2 {#CPU.CORE}'
              type: DEPENDENT
              key: 'hyperv.cpu.usage2[{#VMNAME},*]'
              delay: '0'
              master_item:
                key: 'hyperv.vm.cpu.usage["{#VMNAME_SAFE}","{#COUNTER_PATH_LOCAL}",*]'
            - uuid: 2ff9d70a0f41427e831760badda86ed8
              name: 'Hyper-V CPU Usage {#CPU.CORE}'
              key: 'hyperv.vm.cpu.usage["{#VMNAME_SAFE}","{#COUNTER_PATH_LOCAL}",*]'
              value_type: FLOAT
              trends: '0'
              units: '%'
              description: |
                CPU usage for virtual processor {#VMNAME} {#INSTANCE}
                Core: {#CPU.CORE}
              timeout: 30s
          master_item:
            key: 'hyperv.vm.counters[{HOST.HOST}]'
          lld_macro_paths:
            - lld_macro: '{#COUNTER_PATH_LOCAL}'
              path: '$["{#COUNTER_PATH_LOCAL}"]'
            - lld_macro: '{#COUNTER_PATH}'
              path: '$["{#COUNTER_PATH}"]'
            - lld_macro: '{#INSTANCE}'
              path: '$["{#INSTANCE}"]'
            - lld_macro: '{#ITEM_TYPE}'
              path: '$["{#ITEM_TYPE}"]'
            - lld_macro: '{#METRIC}'
              path: '$["{#METRIC}"]'
            - lld_macro: '{#VMNAME_SAFE}'
              path: '$["{#VMNAME_SAFE}"]'
            - lld_macro: '{#VMNAME}'
              path: '$["{#VMNAME}"]'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$[?(@["{#ITEM_TYPE}"]=="CPU")]'
            - type: JAVASCRIPT
              parameters:
                - |
                  // Fix double backslash escaping in COUNTER_PATH_LOCAL
                  var data = JSON.parse(value);
                  for (var i = 0; i < data.length; i++) {
                    if (data[i]["{#COUNTER_PATH_LOCAL}"]) {
                      data[i]["{#COUNTER_PATH_LOCAL}"] = data[i]["{#COUNTER_PATH_LOCAL}"].replace(/\\\\/g, "\\");
                    }
                  }
                  return JSON.stringify(data);
        - uuid: 21b202dcf4cf4be68e751963040ab4c1
          name: 'Hyper-V VM Disk Discovery'
          type: DEPENDENT
          key: hyperv.vm.disk.discovery
          delay: '0'
          description: 'Discovers Disk performance counters for this Hyper-V VM'
          item_prototypes:
            - uuid: 16ea378f7218481ba6435b61dedc617e
              name: 'Hyper-V Disk Usage {#DISK_SHORT} - {#METRIC}'
              key: 'hyperv.vm.disk.usage["{#VMNAME_SAFE}","{#COUNTER_PATH_LOCAL}"]'
              value_type: FLOAT
              description: |
                Disk for {#VMNAME} {#INSTANCE}
                Name: {#DISK_SHORT}
                Full path: {#DISK_PATH}
              timeout: 30s
          master_item:
            key: 'hyperv.vm.counters[{HOST.HOST}]'
          lld_macro_paths:
            - lld_macro: '{#COUNTER_PATH_LOCAL}'
              path: '$["{#COUNTER_PATH_LOCAL}"]'
            - lld_macro: '{#COUNTER_PATH}'
              path: '$["{#COUNTER_PATH}"]'
            - lld_macro: '{#DISK_PATH}'
              path: '$["{#DISK_PATH}"]'
            - lld_macro: '{#DISK_SHORT}'
              path: '$["{#DISK_SHORT}"]'
            - lld_macro: '{#INSTANCE}'
              path: '$["{#INSTANCE}"]'
            - lld_macro: '{#ITEM_TYPE}'
              path: '$["{#ITEM_TYPE}"]'
            - lld_macro: '{#METRIC}'
              path: '$["{#METRIC}"]'
            - lld_macro: '{#VMNAME_SAFE}'
              path: '$["{#VMNAME_SAFE}"]'
            - lld_macro: '{#VMNAME}'
              path: '$["{#VMNAME}"]'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$[?(@["{#ITEM_TYPE}"]=="DISK")]'
            - type: JAVASCRIPT
              parameters:
                - |
                  // Fix double backslash escaping in COUNTER_PATH_LOCAL
                  var data = JSON.parse(value);
                  for (var i = 0; i < data.length; i++) {
                    if (data[i]["{#COUNTER_PATH_LOCAL}"]) {
                      data[i]["{#COUNTER_PATH_LOCAL}"] = data[i]["{#COUNTER_PATH_LOCAL}"].replace(/\\\\/g, "\\");
                    }
                  }
                  return JSON.stringify(data);
        - uuid: f3ca099ae3fd4925a77eaebb5d2eaf29
          name: 'Hyper-V VM NIC Discovery'
          type: DEPENDENT
          key: hyperv.vm.nic.discovery
          delay: '0'
          description: 'Discovers network performance counters for this Hyper-V VM'
          item_prototypes:
            - uuid: 3d83dfedd67e4f609f66c1e6666cd0b7
              name: 'Hyper-V NIC Usage {#NIC_SHORT} - {#METRIC}'
              key: 'hyperv.vm.nic.usage["{#VMNAME_SAFE}","{#COUNTER_PATH_LOCAL}"]'
              value_type: FLOAT
              description: |
                Network interface for {#VMNAME} {#INSTANCE}
                Name: {#NIC_SHORT}
                Type: {#NIC_TYPE}
              timeout: 30s
          master_item:
            key: 'hyperv.vm.counters[{HOST.HOST}]'
          lld_macro_paths:
            - lld_macro: '{#COUNTER_PATH_LOCAL}'
              path: '$["{#COUNTER_PATH_LOCAL}"]'
            - lld_macro: '{#COUNTER_PATH}'
              path: '$["{#COUNTER_PATH}"]'
            - lld_macro: '{#INSTANCE}'
              path: '$["{#INSTANCE}"]'
            - lld_macro: '{#ITEM_TYPE}'
              path: '$["{#ITEM_TYPE}"]'
            - lld_macro: '{#METRIC}'
              path: '$["{#METRIC}"]'
            - lld_macro: '{#NIC_SHORT}'
              path: '$["{#NIC_SHORT}"]'
            - lld_macro: '{#VMNAME_SAFE}'
              path: '$["{#VMNAME_SAFE}"]'
            - lld_macro: '{#VMNAME}'
              path: '$["{#VMNAME}"]'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$[?(@["{#ITEM_TYPE}"]=="NIC")]'
            - type: JAVASCRIPT
              parameters:
                - |
                  // Fix double backslash escaping in COUNTER_PATH_LOCAL
                  var data = JSON.parse(value);
                  for (var i = 0; i < data.length; i++) {
                    if (data[i]["{#COUNTER_PATH_LOCAL}"]) {
                      data[i]["{#COUNTER_PATH_LOCAL}"] = data[i]["{#COUNTER_PATH_LOCAL}"].replace(/\\\\/g, "\\");
                    }
                  }
                  return JSON.stringify(data);
      graphs:
        - uuid: 771f7eda045f4a8791ee7b989bb38bab
          name: 'Hyper-V VM cpu load {HOST.NAME}'
          width: '900'
          height: '200'
          ymin_type_1: FIXED
          ymax_type_1: FIXED
          graph_items:
            - color: 1A7C11
              calc_fnc: ALL
              item:
                host: 'Template Windows HyperV VM Guest 2025'
                key: 'hyperv.cpu.usage2[{HOST.NAME},*]'
      tags:
        - tag: class
          value: software
        - tag: target
          value: hyperv
        - tag: target
          value: hyperv-client
